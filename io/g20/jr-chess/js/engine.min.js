/* p4wn, AKA 5k chess - by Douglas Bagnall <douglas@paradise.net.nz>
 *
 * This code is in the public domain, or as close to it as various
 * laws allow. No warranty; no restrictions.
 *
 * lives at http://p4wn.sf.net/
 */

function p4_alphabeta_treeclimber(a,b,c,d,e,f,g,h){var j,i=p4_make_move(a,e,f,P4_QUEEN),k=1-c,l=p4_parse(a,c,i.ep,-d),m=l.length;if(b){var n;for(j=0;j<m;j++){var o=l[j],p=o[0],q=o[1],r=o[2];if(p>P4_WIN){g=P4_KING_VALUE;break}if(n=-p4_alphabeta_treeclimber(a,b-1,k,p,q,r,-h,-g),n>g&&(g=n),g>=h)break}g<-P4_WIN_NOW&&!p4_check_check(a,c)&&(g=a.stalemate_scores[c]),g<-P4_WIN&&(g+=P4_WIN_DECAY)}else for(;h>g&&--m!=-1;)l[m][0]>g&&(g=l[m][0]);return p4_unmake_move(a,i),g}function p4_prepare(a){var b,c,d,e,f,g=a.pieces=[[],[]],h=a.moveno>>1,i=a.board,j=h>50?0:parseInt(6*Math.exp(h*-.07)),k=h<12,l=h<5,m=[0,0],n=[0,0],o=[0,0];for(b=20;b<100;b++){f=i[b];var p=14&f,q=1&f;p&&(g[q].push([f,b]),p==P4_KING?m[q]=b:(n[q]+=P4_VALUES[p],o[q]=Math.max(o[q],P4_VALUES[p])))}var r=a.draw_timeout>90||a.current_repetitions>=2;r&&p4_log("draw likely",a.current_repetitions,a.draw_timeout),a.values=[[],[]];var s=P4_VALUES[P4_QUEEN],t=n[0]+n[1]+2*s,u=2*(n[1]+s)/t,v=2*(n[0]+s)/t,w=[u,v],x=4*P4_QUEEN/t;for(a.stalemate_scores=[parseInt(.5+2*(u-1)*s),parseInt(.5+2*(v-1)*s)],b=0;b<P4_VALUES.length;b++){var y=P4_VALUES[b];y<P4_WIN?(a.values[0][b]=parseInt(y*u+.5),a.values[1][b]=parseInt(y*v+.5)):(a.values[0][b]=y,a.values[1][b]=y)}a.best_pieces=[parseInt(o[0]*u+.5),parseInt(o[1]*v+.5)];var z=[m[0]%10,m[1]%10],A=[parseInt(m[0]/10),parseInt(m[1]/10)],B=[[],[]];for(e=3;e<9;e++)for(d=1;d<9;d++)b=10*e+d,f=i[b],(14&f)==P4_PAWN&&(0==(1&f)?B[0][d]=e:void 0===B[1][d]&&(B[1][d]=e));var C=h>=20||t<5*s,D=a.weights;for(e=2;e<10;e++)for(d=1;d<9;d++){b=10*e+d;for(var E=P4_CENTRALISING_WEIGHTS[b]*j,F=P4_KNIGHT_WEIGHTS[b],G=0;G<2;G++){var H=Math.abs(z[1-G]-d),I=Math.abs(A[1-G]-e),J=Math.abs(z[G]-d),L=(Math.abs(A[G]-e),Math.max(Math.sqrt(H*H+I*I),1)+1),M=w[G],N=M*M*M,O=e==2+7*G,P=e==3+5*G,Q=e==5+G,R=e==9-7*G,S=(l&&O)*-5,T=parseInt(.3*E)+2*F+S,U=parseInt(.3*E),V=parseInt(.6*E)+F+S;O&&(U+=(4==d||5==d)*(j+!C),U+=(1==d||8==d)*(h>10&&h<20)*-3,U+=(2==d||7==d)*(h>10&&h<20)*-1);var W=parseInt(.5*F+E*(.5-l)),X=2*(k&&O)*j,Y=Math.max(2*x,1),Z=Y*P4_BASE_PAWN_WEIGHTS[G?119-b:b];if(l){if(e>=4&&e<=7){var $=1+3*(5==e||6==e);Z+=parseInt(.1*($+p4_random_int(a,4))*E)}4!=d&&5!=d||(Z-=3*P,Z+=3*Q)}R&&(Z+=a.values[G][P4_QUEEN]-a.values[G][P4_PAWN]),Z+=4*(3==e&&2==A[G]&&Math.abs(J)<2&&5!=z[G]&&4!=d&&5!=d);var _=B[1-G];if((void 0==_[d]||0==G&&_[d]<e||1==G&&_[d]>e)&&(Z+=2),C){T+=2*parseInt(8*M/L),U+=2*((H<2)+(I<2)),V+=3*(Math.abs(H-I)<2),W+=2*parseInt(8/L)+(H*I==0)+(H-I==0);var aa=8*x*P4_CENTRALISING_WEIGHTS[b];X+=parseInt(150*x/(N*L)+aa*N)}if(D[P4_PAWN+G][b]=Z,D[P4_KNIGHT+G][b]=T,D[P4_ROOK+G][b]=U,D[P4_BISHOP+G][b]=V,D[P4_QUEEN+G][b]=W,D[P4_KING+G][b]=X,r&&M<1){var ba=3/N;for(c=2+G;c<14;c+=2)D[c][b]+=p4_random_int(a,ba)}}}a.prepared=!0}function p4_maybe_prepare(a){a.prepared||p4_prepare(a)}function p4_parse(a,b,c,d){var f,g,h,i,j,k,p,e=a.board,l=1-b,m=10-20*b,n=[],o=[],q=a.pieces[b],r=a.castles>>2*b&3,s=a.values[l],t=a.weights;for(k=q.length-1;k>=0;k--){f=q[k][1],i=e[f];var u=t[i];if(p=d-u[f],i&=14,i>2){var v=P4_MOVES[i];if(2&i){for(j=0;j<8;j++)g=f+v[j],h=e[g],h?(17&h)==l&&o.push([p+s[h]+u[g]+t[h][g],f,g]):n.push([p+s[h]+u[g],f,g]);i==P4_KING&&r&&(1&r&&e[f-1]+e[f-2]+e[f-3]==0&&p4_check_castling(e,f-2,l,m,-1)&&n.push([p+12,f,f-2]),2&r&&e[f+1]+e[f+2]==0&&p4_check_castling(e,f,l,m,1)&&n.push([p+13,f,f+2]))}else{var w=v.length;for(j=0;j<w;){var x=v[j++];g=f;do g+=x,h=e[g],h?(17&h)==l&&o.push([p+s[h]+u[g]+t[h][g],f,g]):n.push([p+s[h]+u[g],f,g]);while(!h)}}}else{if(g=f+m,!e[g]){n.push([p+u[g],f,g]);var y=g+m;f*(120-f)<3200&&!e[y]&&n.push([p+u[y],f,y])}h=e[--g],h&&(17&h)==l&&o.push([p+s[h]+u[g]+t[h][g],f,g]),g+=2,h=e[g],h&&(17&h)==l&&o.push([p+s[h]+u[g]+t[h][g],f,g])}}if(c){var A,z=P4_PAWN|b;f=c-m-1,e[f]==z&&(A=s[P4_PAWN]+t[P4_PAWN|l][c-m],o.push([d-u[f]+u[c]+A,f,c])),f+=2,e[f]==z&&(A=s[P4_PAWN]+t[P4_PAWN|l][c-m],o.push([d-u[f]+u[c]+A,f,c]))}return o.concat(n)}function p4_check_castling(a,b,c,d,e){var f,g,i,j=c+P4_KNIGHT,k=P4_BISHOP|c,l=27,m=P4_ROOK|c,n=2|c,o=23;for(i=b;i<b+3;i++){f=i;do f+=d,g=a[f];while(!g);if((g&o)==m)return 0;f=i;var p=d-1;do f+=p,g=a[f];while(!g);if((g&l)==k)return 0;f=i,p+=2;do f+=p,g=a[f];while(!g);if((g&l)==k)return 0;if(a[i+d-2]==j||a[i+d+2]==j)return 0}for(i=b+d-1;i<b+d+4;i++)if(g=a[i]&o,g==n||a[i+d]==j)return 0;f=e<0?b+2:b;do f-=e,g=a[f];while(!g);return(g&o)==m?0:1}function p4_check_check(a,b){var e,c=a.board,d=a.pieces[b],f=d.length;do e=d[--f];while(e[0]!=(P4_KING|b));var g=e[1],h=1-b,i=10-20*b;if(c[g+i-1]==(P4_PAWN|h)||c[g+i+1]==(P4_PAWN|h))return!0;var j=P4_MOVES[P4_KNIGHT],k=P4_MOVES[P4_KING],l=P4_KNIGHT|h,m=P4_KING|h;for(f=0;f<8;f++)if(c[g+j[f]]==l||c[g+k[f]]==m)return!0;var n=P4_MOVES[P4_BISHOP],o=P4_MOVES[P4_ROOK],p=P4_BISHOP|h,q=27,r=P4_ROOK|h,s=23;for(f=0;f<4;f++){var v,t=n[f],u=g;do u+=t,v=c[u];while(!v);if((v&q)==p)return!0;t=o[f],u=g;do u+=t,v=c[u];while(!v);if((v&s)==r)return!0}return!1}function p4_optimise_piece_list(a){for(var b,c,d,e,f=[p4_parse(a,0,0,0),p4_parse(a,1,0,0)],h=(a.weights,a.board),i=0;i<2;i++){var j=a.values[i],k=a.pieces[i],l=f[i],m=f[1-i],n=[];for(b=0;b<k.length;b++)c=k[b],n[c[1]]={score:0,piece:c[0],pos:c[1],threatened:0};for(b=l.length-1;b>=0;b--){var o=l[b],p=o[0];if(d=o[1],e=o[2],!h[e]){var q=n[d];q.score=Math.max(q.score,p)}}for(b=m.length-1;b>=0;b--){var o=m[b],q=n[o[2]];if(void 0!==q){var r=h[o[1]],s=.01*(1+q.piece>3+r<4);q.threatened<s&&(q.threatened=s)}}var t=[];for(b=20;b<100;b++)c=n[b],void 0!==c&&(c.score+=c.threatened*j[c.piece],t.push(c));for(t.sort(function(a,b){return a.score-b.score}),b=0;b<t.length;b++)c=t[b],k[b]=[c.piece,c.pos]}}function p4_findmove(a,b,c,d){p4_prepare(a),p4_optimise_piece_list(a);a.board;2==arguments.length&&(c=a.to_play,d=a.enpassant);var h,i,j,f=p4_parse(a,c,d,0),g=P4_MIN_SCORE,k=0,l=0;if(b<=0){for(j=0;j<f.length;j++)h=f[j],f[j][0]>g&&(g=h[0],k=h[1],l=h[2]);return[k,l,g]}for(j=0;j<f.length;j++){h=f[j];var m=h[0],n=h[1],o=h[2];if(m>P4_WIN){p4_log("XXX taking king! it should never come to this"),g=P4_KING_VALUE,k=n,l=o;break}i=-a.treeclimber(a,b-1,1-c,m,n,o,P4_MIN_SCORE,-g),i>g&&(g=i,k=n,l=o)}return g<-P4_WIN_NOW&&!p4_check_check(a,c)&&(g=a.stalemate_scores[c]),[k,l,g]}function p4_make_move(a,b,c,d){var e=a.board,f=e[b],g=e[c];e[c]=f,e[b]=0;var l,m,o,h=14&f,i=1&f,j=f,k=0,n=0,p=0;h==P4_PAWN?(60-c)*(60-c)>900?(d|=i,e[c]=d,j=d):1&(b^c)&&0==g?(o=c-10+20*i,n=e[o],e[o]=0):(b-c)*(b-c)==400&&(p=b+c>>1):h==P4_KING&&(b-c)*(b-c)==4&&(k=b-4+7*(b<c),l=b+c>>1,m=i+P4_ROOK,e[k]=0,e[l]=m);var q=a.castles;if(q){var r=0,s=2*i,t=70*i,u=b-t,v=c+t;25==u?r|=3<<s:21==u?r|=1<<s:28==u&&(r|=2<<s),91==v?r|=4>>s:98==v&&(r|=8>>s),a.castles&=~r}for(var w=a.pieces.concat(),x=w[i],y=a.pieces[i]=[],z=0;z<x.length;z++){var A=x[z],C=(A[0],A[1]);C!=b&&C!=k&&y.push(A)}if(y.push([j,c]),m&&y.push([m,l]),g||n){var D=w[1-i];y=a.pieces[1-i]=[];var E=n?o:c;for(z=0;z<D.length;z++){var A=D[z];A[1]!=E&&y.push(A)}}return{s:b,e:c,S:f,E:g,ep:p,castles:q,rs:k,re:l,rook:m,ep_position:o,ep_taken:n,pieces:w}}function p4_unmake_move(a,b){var c=a.board;b.ep_position&&(c[b.ep_position]=b.ep_taken),c[b.s]=b.S,c[b.e]=b.E,b.rs&&(c[b.rs]=b.rook,c[b.re]=0),a.pieces=b.pieces,a.castles=b.castles}function p4_insufficient_material(a){var d,b=!1,c=void 0,e=a.board;for(d=20;d<100;d++){var f=14&e[d];if(0!=f&&f!=P4_KING)if(f==P4_KNIGHT){if(b||void 0!==c)return!1;b=!0}else{if(f!=P4_BISHOP)return!1;var g=1&d,h=1&parseInt(d/10),i=g^h;if(b)return!1;if(void 0===c)c=i;else if(c!=i)return!1}}return!0}function p4_move(a,b,c,d){var e=a.board,f=a.to_play,g=1-f;if(b!=parseInt(b))if(void 0===c){var h=p4_interpret_movestring(a,b);if(b=h[0],c=h[1],0==b)return{flags:P4_MOVE_ILLEGAL,ok:!1};d=h[2]}else b=p4_destringify_point(b),c=p4_destringify_point(c);void 0===d&&(d=P4_QUEEN);var k,j=(e[c],e[b]),l=!1;p4_maybe_prepare(a);var m=p4_parse(a,f,a.enpassant,0);for(k=0;k<m.length;k++)if(c==m[k][2]&&b==m[k][1]){l=!0;break}if(!l)return{flags:P4_MOVE_ILLEGAL,ok:!1};var n=p4_make_move(a,b,c,d);if(p4_check_check(a,f))return p4_unmake_move(a,n),p4_log("in check",n),{flags:P4_MOVE_ILLEGAL,ok:!1,string:"in check!"};var o=P4_MOVE_FLAG_OK;a.enpassant=n.ep,a.history.push([b,c,d]),n.E||n.ep_position?(a.draw_timeout=0,o|=P4_MOVE_FLAG_CAPTURE):(14&j)==P4_PAWN?a.draw_timeout=0:a.draw_timeout++,n.rs&&(o|=b>c?P4_MOVE_FLAG_CASTLE_QUEEN:P4_MOVE_FLAG_CASTLE_KING);var p=p4_state2fen(a,!0),q=(a.position_counts[p]||0)+1;a.position_counts[p]=q,a.current_repetitions=q,(a.draw_timeout>100||q>=3||p4_insufficient_material(a))&&(o|=P4_MOVE_FLAG_DRAW),a.moveno++,a.to_play=g,p4_check_check(a,g)&&(o|=P4_MOVE_FLAG_CHECK);var r=!0,s=p4_parse(a,g,n.ep,0);for(k=0;k<s.length;k++){var t=s[k],u=p4_make_move(a,t[1],t[2],P4_QUEEN),v=p4_check_check(a,g);if(p4_unmake_move(a,u),!v){r=!1;break}}r&&(o|=P4_MOVE_FLAG_MATE);var w=p4_move2string(a,b,c,j,d,o,m);return a.prepared=!1,{flags:o,string:w,ok:!0}}function p4_move2string(a,b,c,d,e,f,g){var i,j,k,l,h=14&d,m=f&P4_MOVE_FLAG_CAPTURE;if(i=p4_stringify_point(b),j=p4_stringify_point(c),h==P4_PAWN)k=m?i.charAt(0)+"x"+j:j,(c>90||c<30)&&(void 0===e&&(e=P4_QUEEN),k+="="+P4_ENCODE_LUT.charAt(e));else if(h==P4_KING&&(b-c)*(b-c)==4)k=c<b?"O-O-O":"O-O";else{var n="",o="",p=P4_ENCODE_LUT.charAt(d),q=b%10,r=parseInt(b/10),s=[];for(l=0;l<g.length;l++){var t=g[l];c==t[2]&&b!=t[1]&&a.board[t[1]]==d&&s.push(t[1])}if(s.length){for(l=0;l<s.length;l++){var u=s[l],v=u%10,w=parseInt(u/10);v==q&&(n=i.charAt(1)),w==r&&(o=i.charAt(0))}""==n&&""==o&&(o=i.charAt(0))}k=p+o+n+(m?"x":"")+j}return f&P4_MOVE_FLAG_CHECK?k+=f&P4_MOVE_FLAG_MATE?"#":"+":f&P4_MOVE_FLAG_MATE&&(k+=" stalemate"),k}function p4_jump_to_moveno(a,b){p4_log("jumping to move",b),void 0===b||b>a.moveno?b=a.moveno:b<0&&(b=a.moveno+b);for(var c=p4_fen2state(a.beginning),d=0;c.moveno<b;){var e=a.history[d++];p4_move(c,e[0],e[1],e[2])}var f,g;for(f in c){var h=c[f];if(f instanceof Array)for(g=a[f],g.length=0,d=0;d<h.length;d++)g[d]=h[d];else a[f]=h}a.prepared=!1}function p4_state2fen(a,b){for(var c="  PpRrNnBbKkQq",d=a.board,e="",f=9;f>1;f--){for(var g=0,h=1;h<9;h++){var i=d[10*f+h];0==i?g++:(g&&(e+=g.toString()),e+=c.charAt(i),g=0)}g&&(e+=g),f>2&&(e+="/")}if(e+=" "+"wb".charAt(a.to_play)+" ",a.castles)for(var j=[2,"K",1,"Q",8,"k",4,"q"],k=0;k<8;k+=2)a.castles&j[k]&&(e+=j[k+1]);else e+="-";return e+=0!==a.enpassant?" "+p4_stringify_point(a.enpassant):" -",b?e:(e+=" "+a.draw_timeout+" ",e+=(a.moveno>>1)+1)}function p4_stringify_point(a){var b=" abcdefgh",c=a%10,d=(a-c)/10-1;return b.charAt(c)+d}function p4_destringify_point(a){var b=parseInt(a.charAt(0),19)-9,c=parseInt(a.charAt(1))+1;if(c>=2&&c<10&&b>=1&&b<9)return 10*c+b}function p4_fen2state(a,b){void 0===b&&(b=p4_initialise_state());var c=b.board,d=a.split(" "),e=d[0],f=d[1],g=d[2],h=d[3],i=d[4],j=d[5];void 0===i&&(i=0);for(var m,n,k=90,l=1,o=0;o<e.length;o++)if(n=e.charAt(o),"/"!=n){var p=P4_PIECE_LUT[n];if(p&&l<9)c[k+l]=p,l++;else for(var q=Math.min(l+parseInt(n),9);l<q;l++)c[k+l]=0}else if(l=1,k-=10,k<20)break;b.to_play="b"==f.toLowerCase()?1:0,b.castles=0;var r=c[25]==P4_KING,s=c[95]==P4_KING+1,t={k:8*(s&&c[98]==P4_ROOK+1),q:4*(s&&c[91]==P4_ROOK+1),K:2*(r&&c[28]==P4_ROOK),Q:1*(r&&c[21]==P4_ROOK)};for(m=0;m<g.length;m++){n=g.charAt(m);var u=t[n];void 0!==u&&(b.castles|=u,0==u&&console.log("FEN claims castle state "+g+" but pieces are not in place for "+n))}if(b.enpassant="-"!=h?p4_destringify_point(h):0,b.draw_timeout=parseInt(i),void 0===j){var x,y,v=0,w=0;for(k=20;k<100;k+=10)for(l=1;l<9;l++)x=15&c[k+l],v+=!!x,l<8&&(y=c[k+l+1],w+=!y!=!x),k<90&&(y=c[k+l+10],w+=!y!=!x);j=Math.max(1,parseInt(1.3*(32-v)+1.5*(4-g.length)+(w-16)/5))}return b.moveno=2*(parseInt(j)-1)+b.to_play,b.history=[],b.beginning=a,b.prepared=!1,b.position_counts={},b.move=function(a,b,c){return p4_move(this,a,b,c)},b.findmove=function(a){return p4_findmove(this,a)},b.jump_to_moveno=function(a){return p4_jump_to_moveno(this,a)},b}function p4_zero_array(){if(P4_USE_TYPED_ARRAYS)return new Int32Array(120);if(0==P4_ZEROS.length)for(var a=0;a<120;a++)P4_ZEROS[a]=0;return P4_ZEROS.slice()}function p4_initialise_state(){var a=p4_zero_array();P4_CENTRALISING_WEIGHTS=p4_zero_array(),P4_BASE_PAWN_WEIGHTS=p4_zero_array(),P4_KNIGHT_WEIGHTS=p4_zero_array();for(var b=0;b<120;b++){var c=parseInt(b/10),d=b%10,e=Math.abs(d-4.5),f=Math.abs(c-5.5);P4_CENTRALISING_WEIGHTS[b]=parseInt(6-Math.pow(1.5*(e*e+f*f),.6)),P4_KNIGHT_WEIGHTS[b]=parseInt((e<2)+1.5*(f<2)+(e<3)+(f<3))-2,P4_BASE_PAWN_WEIGHTS[b]=parseInt("000012347000".charAt(c)),(c>9||c<2||d<1||d>8)&&(a[b]=16)}var g=[];for(b=0;b<14;b++)g[b]=p4_zero_array();var h={board:a,weights:g,history:[],treeclimber:p4_alphabeta_treeclimber};return p4_random_seed(h,P4_DEBUG?1:Date.now()),h}function p4_new_game(){return p4_fen2state(P4_INITIAL_BOARD)}function p4_interpret_movestring(a,b){var c=[0,0],d=/^\s*([RNBQK]?[a-h]?[1-8]?)[ :x-]*([a-h][1-8]?)(=[RNBQ])?[!?+#e.p]*\s*$/,e=/^\s*([O0o]-[O0o](-[O0o])?)\s*$/,f=/^[a-h][1-8]$/,g=d.exec(b);if(null==g){if(g=e.exec(b),!g)return c;k=25+70*a.to_play,l=g[2]?k-2:k+2}var k,l,m,h=g[1],i=g[2],j=g[3];return""==h||void 0==h?(l=p4_destringify_point(i),k=p4_find_source_point(a,l,"P"+i.charAt(0))):/^[RNBQK]/.test(h)?(l=p4_destringify_point(i),k=p4_find_source_point(a,l,h)):f.test(h)&&f.test(i)?(k=p4_destringify_point(h),l=p4_destringify_point(i)):/^[a-h]$/.test(h)&&(l=p4_destringify_point(i),k=p4_find_source_point(a,l,"P"+h)),0==k?c:(j&&(m=P4_PIECE_LUT[j.charAt(1)]),[k,l,m])}function p4_find_source_point(a,b,c){var d=a.to_play,e=P4_PIECE_LUT[c.charAt(0)];e|=d;var f,g,h,i;for(g=1;g<c.length;g++){var j=c.charAt(g);/[a-h]/.test(j)?i=c.charCodeAt(g)-96:/[1-8]/.test(j)&&(h=1+parseInt(j))}var k=[];p4_prepare(a);var l=p4_parse(a,d,a.enpassant,0);for(g=0;g<l.length;g++){var m=l[g];if(b==m[2]&&(f=m[1],!(a.board[f]!=e||void 0!==i&&i!=f%10||void 0!==h&&h!=parseInt(f/10)))){var n=p4_make_move(a,f,b,P4_QUEEN);p4_check_check(a,d)||k.push(f),p4_unmake_move(a,n)}}return p4_log("finding",c,"that goes to",b,"got",k),0==k.length?0:(k.length>1&&p4_log("p4_find_source_point seems to have failed",a,b,c,k),k[0])}function p4_random_seed(a,b){b&=4294967295,a.rng=P4_USE_TYPED_ARRAYS?new Uint32Array(4):[],a.rng[0]=4058668781,a.rng[1]=b,a.rng[2]=b,a.rng[3]=b;for(var c=0;c<20;c++)p4_random31(a)}function p4_random31(a){var b=a.rng,c=b[1],d=b[2],e=b[0]-(c<<27|c>>>5);return b[0]=c^(d<<17|d>>>15),b[1]=d+b[3]&4294967295,b[2]=b[3]+e&4294967295,b[3]=e+b[0]&4294967295,2147483647&b[3]}function p4_random_int(a,b){var c=b;c--,c|=c>>>1,c|=c>>>2,c|=c>>>4,c|=c>>>8,c|=c>>>16;var d;do d=p4_random31(a)&c;while(d>=b);return d}var p4_log;p4_log=void 0!==this.imports&&void 0!==this.printerr?function(){var a=Array.prototype.slice.call(arguments);printerr(a.join(", "))}:void 0===this.console?function(){}:function(){console.log.apply(console,arguments)},void 0===Date.now&&(Date.now=function(){return(new Date).getTime()});var P4_PAWN=2,P4_ROOK=4,P4_KNIGHT=6,P4_BISHOP=8,P4_QUEEN=12,P4_KING=10,P4_EDGE=16,P4_MOVES=[[],[],[],[],[1,10,-1,-10],[],[21,19,12,8,-21,-19,-12,-8],[],[11,9,-11,-9],[],[1,10,11,9,-1,-10,-11,-9],[],[1,10,11,9,-1,-10,-11,-9],[]],P4_VALUES=[0,0,20,20,100,100,60,60,61,61,8e3,8e3,180,180,0],P4_KING_VALUE=P4_VALUES[10],P4_WIN=P4_KING_VALUE>>1,P4_WIN_DECAY=300,P4_WIN_NOW=P4_KING_VALUE-250,P4_MAX_SCORE=9999,P4_MIN_SCORE=-P4_MAX_SCORE,P4_CENTRALISING_WEIGHTS,P4_BASE_PAWN_WEIGHTS,P4_KNIGHT_WEIGHTS,P4_DEBUG=0,P4_INITIAL_BOARD="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 1 1",P4_USE_TYPED_ARRAYS=void 0!==this.Int32Array,P4_PIECE_LUT={P:2,p:3,R:4,r:5,N:6,n:7,B:8,b:9,K:10,k:11,Q:12,q:13},P4_ENCODE_LUT="  PPRRNNBBKKQQ",P4_MOVE_FLAG_OK=1,P4_MOVE_FLAG_CHECK=2,P4_MOVE_FLAG_MATE=4,P4_MOVE_FLAG_CAPTURE=8,P4_MOVE_FLAG_CASTLE_KING=16,P4_MOVE_FLAG_CASTLE_QUEEN=32,P4_MOVE_FLAG_DRAW=64,P4_MOVE_ILLEGAL=0,P4_MOVE_MISSED_MATE=P4_MOVE_FLAG_CHECK|P4_MOVE_FLAG_MATE,P4_MOVE_CHECKMATE=P4_MOVE_FLAG_OK|P4_MOVE_FLAG_CHECK|P4_MOVE_FLAG_MATE,P4_MOVE_STALEMATE=P4_MOVE_FLAG_OK|P4_MOVE_FLAG_MATE,P4_ZEROS=[];